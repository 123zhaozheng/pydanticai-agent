{
  "id": "snapshot_1766048428368_pvp3lm6kv",
  "approvalId": "approval_1766048428342_obzt9oppu",
  "approvalTitle": "Requirements Document - Agent Management API",
  "version": 1,
  "timestamp": "2025-12-18T09:00:28.368Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Requirements: Agent Management API\r\n\r\n## Overview\r\n\r\nA comprehensive FastAPI-based agent management system that provides session interaction, conversation history, skill management, toolset management, and role-based access control (RBAC). The system integrates with pydantic-deepagents to provide secure, multi-user AI agent capabilities with fine-grained permissions.\r\n\r\n## Target Users\r\n\r\n- **End Users**: Interact with AI agents through authenticated sessions\r\n- **Administrators**: Manage users, roles, permissions, skills, and toolsets\r\n- **Developers**: Integrate agent capabilities into applications via RESTful and WebSocket APIs\r\n\r\n## User Stories\r\n\r\n### Authentication & Authorization\r\n\r\n**US-1**: As a user, I want to authenticate with JWT tokens so that my sessions are secure.\r\n- **EARS**: WHEN a user provides valid credentials, THEN the system SHALL issue a JWT token with user ID and roles.\r\n- **Priority**: Critical\r\n- **Acceptance Criteria**:\r\n  - Username/password authentication endpoint\r\n  - JWT token generation with configurable expiration\r\n  - Token refresh mechanism\r\n  - Secure password hashing (bcrypt/argon2)\r\n\r\n**US-2**: As an admin, I want to manage user roles so that I can control access to features.\r\n- **EARS**: WHEN an admin assigns a role to a user, THEN the user SHALL have access to all permissions associated with that role.\r\n- **Priority**: Critical\r\n- **Acceptance Criteria**:\r\n  - Create/read/update/delete roles\r\n  - Assign/revoke roles from users\r\n  - Define menu, button, and agent permissions per role\r\n  - Admin-only endpoints protected by `get_admin_user` dependency\r\n\r\n**US-3**: As a system, I want to check permissions before executing actions so that unauthorized access is prevented.\r\n- **EARS**: WHEN a user attempts an action, IF they lack the required permission, THEN the system SHALL return 403 Forbidden.\r\n- **Priority**: Critical\r\n- **Acceptance Criteria**:\r\n  - Permission check middleware using `check_permission`\r\n  - Permission keys for all protected actions\r\n  - Clear error messages indicating missing permissions\r\n\r\n### Session Management\r\n\r\n**US-4**: As a user, I want to start a new agent conversation so that I can interact with AI assistants.\r\n- **EARS**: WHEN a user creates a session, THEN the system SHALL initialize an agent with user-specific configuration and return a session ID.\r\n- **Priority**: High\r\n- **Acceptance Criteria**:\r\n  - POST `/api/sessions` endpoint\r\n  - Session ID generation (UUID)\r\n  - Associate session with authenticated user\r\n  - Store session metadata (created_at, model, toolsets, etc.)\r\n\r\n**US-5**: As a user, I want to send messages to an agent and receive streaming responses so that I have a real-time conversation experience.\r\n- **EARS**: WHEN a user sends a message, THEN the system SHALL stream the agent's response in real-time using Server-Sent Events (SSE) or WebSocket.\r\n- **Priority**: High\r\n- **Acceptance Criteria**:\r\n  - POST `/api/sessions/{session_id}/messages` endpoint\r\n  - Streaming response using FastAPI StreamingResponse or WebSocket\r\n  - Support for both text and structured outputs\r\n  - Handle agent tool calls transparently\r\n  - Return message ID and timestamps\r\n\r\n**US-6**: As a user, I want to view my conversation history so that I can review past interactions.\r\n- **EARS**: WHEN a user requests conversation history, THEN the system SHALL return all messages in chronological order with metadata.\r\n- **Priority**: Medium\r\n- **Acceptance Criteria**:\r\n  - GET `/api/sessions/{session_id}/history` endpoint\r\n  - Pagination support (limit, offset)\r\n  - Filter by date range\r\n  - Include message role (user/assistant/system), content, and timestamps\r\n  - Only show user's own sessions (enforced by `get_current_user`)\r\n\r\n**US-7**: As a user, I want to list all my sessions so that I can resume previous conversations.\r\n- **EARS**: WHEN a user requests their sessions, THEN the system SHALL return all sessions with summary information.\r\n- **Priority**: Medium\r\n- **Acceptance Criteria**:\r\n  - GET `/api/sessions` endpoint\r\n  - Return session ID, title, created_at, updated_at, message count\r\n  - Sort by most recent first\r\n  - Pagination support\r\n\r\n**US-8**: As a user, I want to delete old sessions so that I can manage my data.\r\n- **EARS**: WHEN a user deletes a session, THEN the system SHALL remove the session and all associated messages.\r\n- **Priority**: Low\r\n- **Acceptance Criteria**:\r\n  - DELETE `/api/sessions/{session_id}` endpoint\r\n  - Cascade delete all messages\r\n  - Only session owner can delete (enforced by authorization check)\r\n\r\n### Skill Management\r\n\r\n**US-9**: As an admin, I want to create skills so that agents can use specialized capabilities.\r\n- **EARS**: WHEN an admin creates a skill, THEN the system SHALL validate the skill definition and store it in the skills directory.\r\n- **Priority**: High\r\n- **Acceptance Criteria**:\r\n  - POST `/api/skills` endpoint (admin-only)\r\n  - Validate skill markdown format (YAML frontmatter + content)\r\n  - Check required fields: name, description, examples\r\n  - Store in configured skills directory\r\n  - Return skill ID and metadata\r\n\r\n**US-10**: As a user, I want to list available skills so that I can understand agent capabilities.\r\n- **EARS**: WHEN a user requests skills, THEN the system SHALL return all skills they have permission to access.\r\n- **Priority**: Medium\r\n- **Acceptance Criteria**:\r\n  - GET `/api/skills` endpoint\r\n  - Filter skills by user's role permissions (if `AgentPermission` includes skill access)\r\n  - Return skill name, description, category, and example usage\r\n  - Support search/filter by category or keyword\r\n\r\n**US-11**: As an admin, I want to update skill definitions so that I can improve agent behavior.\r\n- **EARS**: WHEN an admin updates a skill, THEN the system SHALL validate changes and update the skill file.\r\n- **Priority**: Medium\r\n- **Acceptance Criteria**:\r\n  - PUT `/api/skills/{skill_id}` endpoint (admin-only)\r\n  - Validate updated skill definition\r\n  - Preserve skill ID/name (or handle renaming)\r\n  - Return updated skill metadata\r\n\r\n**US-12**: As an admin, I want to delete skills so that I can remove obsolete capabilities.\r\n- **EARS**: WHEN an admin deletes a skill, THEN the system SHALL remove the skill file and update any references.\r\n- **Priority**: Low\r\n- **Acceptance Criteria**:\r\n  - DELETE `/api/skills/{skill_id}` endpoint (admin-only)\r\n  - Remove skill markdown file\r\n  - Return confirmation\r\n  - Handle gracefully if skill is in use (soft delete or warning)\r\n\r\n### Toolset Management\r\n\r\n**US-13**: As an admin, I want to register custom toolsets so that agents have access to new tools.\r\n- **EARS**: WHEN an admin registers a toolset, THEN the system SHALL validate the toolset class and make it available for agents.\r\n- **Priority**: High\r\n- **Acceptance Criteria**:\r\n  - POST `/api/toolsets` endpoint (admin-only)\r\n  - Accept toolset definition (class name, module path, configuration)\r\n  - Validate toolset implements required interface\r\n  - Store toolset metadata in database\r\n  - Return toolset ID and available tools\r\n\r\n**US-14**: As a user, I want to list available toolsets so that I can choose which tools to enable in sessions.\r\n- **EARS**: WHEN a user requests toolsets, THEN the system SHALL return all toolsets they have permission to use.\r\n- **Priority**: Medium\r\n- **Acceptance Criteria**:\r\n  - GET `/api/toolsets` endpoint\r\n  - Filter by user's role permissions\r\n  - Return toolset name, description, and list of tools\r\n  - Include usage examples\r\n\r\n**US-15**: As an admin, I want to update toolset configurations so that I can modify tool behavior.\r\n- **EARS**: WHEN an admin updates a toolset, THEN the system SHALL validate and apply the new configuration.\r\n- **Priority**: Medium\r\n- **Acceptance Criteria**:\r\n  - PUT `/api/toolsets/{toolset_id}` endpoint (admin-only)\r\n  - Validate configuration schema\r\n  - Apply changes without restarting server (hot reload)\r\n  - Return updated toolset metadata\r\n\r\n**US-16**: As an admin, I want to disable toolsets so that I can prevent access to certain tools.\r\n- **EARS**: WHEN an admin disables a toolset, THEN users SHALL no longer be able to use it in new sessions.\r\n- **Priority**: Medium\r\n- **Acceptance Criteria**:\r\n  - PATCH `/api/toolsets/{toolset_id}/disable` endpoint (admin-only)\r\n  - Mark toolset as disabled in database\r\n  - Existing sessions continue to work\r\n  - New sessions cannot use disabled toolset\r\n\r\n### User Management\r\n\r\n**US-17**: As an admin, I want to create user accounts so that new users can access the system.\r\n- **EARS**: WHEN an admin creates a user, THEN the system SHALL validate uniqueness and create the user with default permissions.\r\n- **Priority**: High\r\n- **Acceptance Criteria**:\r\n  - POST `/api/users` endpoint (admin-only)\r\n  - Validate unique username and email\r\n  - Hash password securely\r\n  - Assign default role if specified\r\n  - Return user ID and profile\r\n\r\n**US-18**: As an admin, I want to list all users so that I can manage accounts.\r\n- **EARS**: WHEN an admin requests users, THEN the system SHALL return all user accounts with their roles and status.\r\n- **Priority**: Medium\r\n- **Acceptance Criteria**:\r\n  - GET `/api/users` endpoint (admin-only)\r\n  - Return user ID, username, email, roles, is_active, is_admin\r\n  - Pagination and search support\r\n  - Exclude sensitive fields (hashed_password)\r\n\r\n**US-19**: As a user, I want to update my profile so that I can keep my information current.\r\n- **EARS**: WHEN a user updates their profile, THEN the system SHALL validate and save the changes.\r\n- **Priority**: Medium\r\n- **Acceptance Criteria**:\r\n  - PUT `/api/users/me` endpoint\r\n  - Allow updating: full_name, email, phone, avatar\r\n  - Validate email format and uniqueness\r\n  - Require current password for sensitive changes\r\n\r\n**US-20**: As an admin, I want to deactivate user accounts so that I can revoke access without deleting data.\r\n- **EARS**: WHEN an admin deactivates a user, THEN the user SHALL no longer be able to authenticate.\r\n- **Priority**: Medium\r\n- **Acceptance Criteria**:\r\n  - PATCH `/api/users/{user_id}/deactivate` endpoint (admin-only)\r\n  - Set is_active = False\r\n  - Reject authentication attempts with clear message\r\n  - Preserve user data and session history\r\n\r\n## Non-Functional Requirements\r\n\r\n### Performance\r\n- **NFR-1**: API endpoints SHALL respond within 200ms for non-streaming requests (95th percentile)\r\n- **NFR-2**: Streaming responses SHALL begin within 500ms of request\r\n- **NFR-3**: System SHALL support at least 100 concurrent users\r\n\r\n### Security\r\n- **NFR-4**: All passwords SHALL be hashed using bcrypt or argon2 with appropriate cost factor\r\n- **NFR-5**: JWT tokens SHALL use HS256 or RS256 algorithm with secure secret keys\r\n- **NFR-6**: All API endpoints SHALL enforce authentication except public login endpoints\r\n- **NFR-7**: SQL injection SHALL be prevented via parameterized queries (SQLAlchemy ORM)\r\n\r\n### Scalability\r\n- **NFR-8**: Database connections SHALL use connection pooling\r\n- **NFR-9**: Session state SHALL be stored in database for horizontal scaling\r\n- **NFR-10**: File storage (skills, toolsets) SHALL support external storage backends\r\n\r\n### Maintainability\r\n- **NFR-11**: All endpoints SHALL have OpenAPI documentation\r\n- **NFR-12**: Code coverage SHALL be at least 80%\r\n- **NFR-13**: All public APIs SHALL have docstrings\r\n\r\n### Compatibility\r\n- **NFR-14**: API SHALL follow RESTful conventions\r\n- **NFR-15**: WebSocket/SSE SHALL follow standard protocols for broad client compatibility\r\n- **NFR-16**: System SHALL support PostgreSQL, MySQL, and SQLite databases\r\n\r\n## Success Metrics\r\n\r\n1. **User Adoption**: 50+ active users within first month\r\n2. **Performance**: <500ms average response time for streaming initiation\r\n3. **Reliability**: 99.5% uptime\r\n4. **Security**: Zero authentication/authorization vulnerabilities in security audit\r\n5. **Developer Experience**: Complete API documentation with working examples\r\n\r\n## Out of Scope\r\n\r\n- Frontend UI implementation (API-only)\r\n- Multi-tenancy (single organization per deployment)\r\n- Real-time collaboration (multiple users in same session)\r\n- Voice/audio interaction\r\n- Agent fine-tuning or model training\r\n\r\n## Dependencies\r\n\r\n- **External**: pydantic-ai, FastAPI, SQLAlchemy, python-jose (JWT), bcrypt/argon2\r\n- **Internal**: pydantic-deepagents (agent factory, toolsets, backends)\r\n- **Infrastructure**: PostgreSQL/MySQL database, Redis (optional for caching)\r\n\r\n## Risks & Mitigations\r\n\r\n| Risk | Impact | Mitigation |\r\n|------|--------|-----------|\r\n| Token security breach | High | Use short-lived tokens, implement refresh tokens, secure key storage |\r\n| Agent prompt injection | High | Input validation, content filtering, rate limiting |\r\n| Database performance with large conversation histories | Medium | Implement pagination, archiving, and indexing strategies |\r\n| Skill/toolset loading performance | Medium | Cache loaded skills, lazy loading, async initialization |\r\n| Permission complexity leads to bugs | Medium | Comprehensive testing, clear documentation, permission audit logs |\r\n\r\n## Assumptions\r\n\r\n1. Users have basic understanding of REST APIs\r\n2. Administrators can write/edit markdown files for skills\r\n3. Toolsets are Python classes following pydantic-deepagents conventions\r\n4. Deployment environment has network access to LLM providers (OpenAI, Anthropic, etc.)\r\n5. Database is set up and migrations are handled externally\r\n\r\n## Glossary\r\n\r\n- **Session**: A conversation instance between a user and an agent\r\n- **Skill**: A reusable capability defined in markdown format that agents can learn\r\n- **Toolset**: A collection of Python functions/tools that agents can call\r\n- **RBAC**: Role-Based Access Control - permission system using roles\r\n- **JWT**: JSON Web Token - authentication token standard\r\n- **SSE**: Server-Sent Events - HTTP streaming protocol\r\n",
  "fileStats": {
    "size": 13876,
    "lines": 284,
    "lastModified": "2025-12-18T09:00:02.764Z"
  },
  "comments": []
}