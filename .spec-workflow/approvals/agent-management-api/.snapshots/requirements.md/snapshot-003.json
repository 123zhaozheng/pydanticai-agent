{
  "id": "snapshot_1766048900075_7bdfk9mnv",
  "approvalId": "approval_1766048428342_obzt9oppu",
  "approvalTitle": "Requirements Document - Agent Management API",
  "version": 3,
  "timestamp": "2025-12-18T09:08:20.075Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# 需求文档：Agent 管理 API\r\n\r\n## 概述\r\n\r\n一个基于 FastAPI 的综合性 Agent 管理系统，提供会话交互、对话历史、技能管理、工具集管理和基于角色的访问控制（RBAC）。该系统集成 pydantic-deepagents，为多用户提供安全的 AI Agent 能力，并支持细粒度权限控制。\r\n\r\n## 目标用户\r\n\r\n- **终端用户**：通过认证会话与 AI Agent 交互\r\n- **管理员**：管理用户、角色、权限、技能和工具集\r\n- **开发者**：通过 RESTful 和 WebSocket API 将 Agent 能力集成到应用中\r\n\r\n## 用户故事\r\n\r\n### 认证与授权\r\n\r\n**US-1**：作为用户，我希望使用 JWT 令牌进行认证，以确保会话安全。\r\n- **EARS**：当用户提供有效凭据时，系统应颁发包含用户 ID 和角色的 JWT 令牌。\r\n- **优先级**：关键\r\n- **验收标准**：\r\n  - 用户名/密码认证端点\r\n  - JWT 令牌生成，支持可配置过期时间\r\n  - 令牌刷新机制\r\n  - 安全密码哈希（bcrypt/argon2）\r\n\r\n**US-2**：作为管理员，我希望管理用户角色，以便控制功能访问权限。\r\n- **EARS**：当管理员为用户分配角色时，用户应拥有该角色关联的所有权限。\r\n- **优先级**：关键\r\n- **验收标准**：\r\n  - 创建/读取/更新/删除角色\r\n  - 为用户分配/撤销角色\r\n  - 为每个角色定义菜单、按钮和 Agent 权限\r\n  - 管理员专用端点由 `get_admin_user` 依赖保护\r\n\r\n**US-3**：作为系统，我希望在执行操作前检查权限，以防止未授权访问。\r\n- **EARS**：当用户尝试执行操作时，如果缺少所需权限，系统应返回 403 Forbidden。\r\n- **优先级**：关键\r\n- **验收标准**：\r\n  - 使用 `check_permission` 的权限检查中间件\r\n  - 所有受保护操作的权限键\r\n  - 清晰的错误消息，指示缺少的权限\r\n\r\n### 会话管理\r\n\r\n**US-4**：作为用户，我希望启动新的 Agent 对话，以便与 AI 助手交互。\r\n- **EARS**：当用户创建会话时，系统应使用用户特定配置初始化 Agent，并返回会话 ID。\r\n- **优先级**：高\r\n- **验收标准**：\r\n  - POST `/api/sessions` 端点\r\n  - 会话 ID 生成（UUID）\r\n  - 将会话关联到已认证用户\r\n  - 存储会话元数据（created_at、model、toolsets 等）\r\n\r\n**US-5**：作为用户，我希望向 Agent 发送消息并接收流式响应，以获得实时对话体验。\r\n- **EARS**：当用户发送消息时，系统应使用 Server-Sent Events (SSE) 或 WebSocket 实时流式传输 Agent 的响应。\r\n- **优先级**：高\r\n- **验收标准**：\r\n  - POST `/api/sessions/{session_id}/messages` 端点\r\n  - 使用 FastAPI StreamingResponse 或 WebSocket 的流式响应\r\n  - 支持文本和结构化输出\r\n  - 透明处理 Agent 工具调用\r\n  - 返回消息 ID 和时间戳\r\n\r\n**US-6**：作为用户，我希望查看对话历史，以便回顾过去的交互。\r\n- **EARS**：当用户请求对话历史时，系统应按时间顺序返回所有消息及元数据。\r\n- **优先级**：中\r\n- **验收标准**：\r\n  - GET `/api/sessions/{session_id}/history` 端点\r\n  - 分页支持（limit、offset）\r\n  - 按日期范围过滤\r\n  - 包含消息角色（user/assistant/system）、内容和时间戳\r\n  - 仅显示用户自己的会话（由 `get_current_user` 强制执行）\r\n\r\n**US-7**：作为用户，我希望列出所有会话，以便恢复之前的对话。\r\n- **EARS**：当用户请求其会话时，系统应返回所有会话及摘要信息。\r\n- **优先级**：中\r\n- **验收标准**：\r\n  - GET `/api/sessions` 端点\r\n  - 返回会话 ID、标题、created_at、updated_at、消息计数\r\n  - 按最近优先排序\r\n  - 分页支持\r\n\r\n**US-8**：作为用户，我希望删除旧会话，以便管理我的数据。\r\n- **EARS**：当用户删除会话时，系统应移除会话及所有关联消息。\r\n- **优先级**：低\r\n- **验收标准**：\r\n  - DELETE `/api/sessions/{session_id}` 端点\r\n  - 级联删除所有消息\r\n  - 仅会话所有者可删除（由授权检查强制执行）\r\n\r\n### 技能管理\r\n\r\n**US-9**：作为管理员，我希望创建技能，以便 Agent 可以使用专门能力。\r\n- **EARS**：当管理员创建技能时，系统应验证技能定义并存储到技能目录。\r\n- **优先级**：高\r\n- **验收标准**：\r\n  - POST `/api/skills` 端点（仅管理员）\r\n  - 验证技能 markdown 格式（YAML frontmatter + 内容）\r\n  - 检查必需字段：name、description、examples\r\n  - 存储到配置的技能目录\r\n  - 返回技能 ID 和元数据\r\n\r\n**US-10**：作为用户，我希望列出可用技能，以便了解 Agent 能力。\r\n- **EARS**：当用户请求技能时，系统应返回其有权访问的所有技能。\r\n- **优先级**：中\r\n- **验收标准**：\r\n  - GET `/api/skills` 端点\r\n  - 根据用户角色权限过滤技能（如果 `AgentPermission` 包含技能访问）\r\n  - 返回技能名称、描述、类别和示例用法\r\n  - 支持按类别或关键词搜索/过滤\r\n\r\n**US-11**：作为管理员，我希望更新技能定义，以便改进 Agent 行为。\r\n- **EARS**：当管理员更新技能时，系统应验证更改并更新技能文件。\r\n- **优先级**：中\r\n- **验收标准**：\r\n  - PUT `/api/skills/{skill_id}` 端点（仅管理员）\r\n  - 验证更新后的技能定义\r\n  - 保留技能 ID/名称（或处理重命名）\r\n  - 返回更新后的技能元数据\r\n\r\n**US-12**：作为管理员，我希望删除技能，以便移除过时的能力。\r\n- **EARS**：当管理员删除技能时，系统应移除技能文件并更新任何引用。\r\n- **优先级**：低\r\n- **验收标准**：\r\n  - DELETE `/api/skills/{skill_id}` 端点（仅管理员）\r\n  - 移除技能 markdown 文件\r\n  - 返回确认\r\n  - 如果技能正在使用，优雅处理（软删除或警告）\r\n\r\n### 工具集管理\r\n\r\n**US-13**：作为管理员，我希望注册自定义工具集，以便 Agent 可以访问新工具。\r\n- **EARS**：当管理员注册工具集时，系统应验证工具集类并使其可供 Agent 使用。\r\n- **优先级**：高\r\n- **验收标准**：\r\n  - POST `/api/toolsets` 端点（仅管理员）\r\n  - 接受工具集定义（类名、模块路径、配置）\r\n  - 验证工具集实现必需接口\r\n  - 在数据库中存储工具集元数据\r\n  - 返回工具集 ID 和可用工具\r\n\r\n**US-14**：作为用户，我希望列出可用工具集，以便选择在会话中启用哪些工具。\r\n- **EARS**：当用户请求工具集时，系统应返回其有权使用的所有工具集。\r\n- **优先级**：中\r\n- **验收标准**：\r\n  - GET `/api/toolsets` 端点\r\n  - 根据用户角色权限过滤\r\n  - 返回工具集名称、描述和工具列表\r\n  - 包含使用示例\r\n\r\n**US-15**：作为管理员，我希望更新工具集配置，以便修改工具行为。\r\n- **EARS**：当管理员更新工具集时，系统应验证并应用新配置。\r\n- **优先级**：中\r\n- **验收标准**：\r\n  - PUT `/api/toolsets/{toolset_id}` 端点（仅管理员）\r\n  - 验证配置架构\r\n  - 应用更改而无需重启服务器（热重载）\r\n  - 返回更新后的工具集元数据\r\n\r\n**US-16**：作为管理员，我希望禁用工具集，以便阻止访问某些工具。\r\n- **EARS**：当管理员禁用工具集时，用户应无法在新会话中使用它。\r\n- **优先级**：中\r\n- **验收标准**：\r\n  - PATCH `/api/toolsets/{toolset_id}/disable` 端点（仅管理员）\r\n  - 在数据库中将工具集标记为禁用\r\n  - 现有会话继续工作\r\n  - 新会话无法使用禁用的工具集\r\n\r\n### 用户管理\r\n\r\n**US-17**：作为管理员，我希望创建用户账户，以便新用户可以访问系统。\r\n- **EARS**：当管理员创建用户时，系统应验证唯一性并创建具有默认权限的用户。\r\n- **优先级**：高\r\n- **验收标准**：\r\n  - POST `/api/users` 端点（仅管理员）\r\n  - 验证用户名和邮箱的唯一性\r\n  - 安全哈希密码\r\n  - 如果指定，分配默认角色\r\n  - 返回用户 ID 和配置文件\r\n\r\n**US-18**：作为管理员，我希望列出所有用户，以便管理账户。\r\n- **EARS**：当管理员请求用户时，系统应返回所有用户账户及其角色和状态。\r\n- **优先级**：中\r\n- **验收标准**：\r\n  - GET `/api/users` 端点（仅管理员）\r\n  - 返回用户 ID、用户名、邮箱、角色、is_active、is_admin\r\n  - 分页和搜索支持\r\n  - 排除敏感字段（hashed_password）\r\n\r\n**US-19**：作为用户，我希望更新个人资料，以便保持信息最新。\r\n- **EARS**：当用户更新其个人资料时，系统应验证并保存更改。\r\n- **优先级**：中\r\n- **验收标准**：\r\n  - PUT `/api/users/me` 端点\r\n  - 允许更新：full_name、email、phone、avatar\r\n  - 验证邮箱格式和唯一性\r\n  - 敏感更改需要当前密码\r\n\r\n**US-20**：作为管理员，我希望停用用户账户，以便在不删除数据的情况下撤销访问权限。\r\n- **EARS**：当管理员停用用户时，该用户应无法再进行认证。\r\n- **优先级**：中\r\n- **验收标准**：\r\n  - PATCH `/api/users/{user_id}/deactivate` 端点（仅管理员）\r\n  - 设置 is_active = False\r\n  - 拒绝认证尝试并给出清晰消息\r\n  - 保留用户数据和会话历史\r\n\r\n## 非功能性需求\r\n\r\n### 性能\r\n- **NFR-1**：非流式请求的 API 端点应在 200ms 内响应（95 百分位）\r\n- **NFR-2**：流式响应应在请求后 500ms 内开始\r\n- **NFR-3**：系统应支持至少 100 个并发用户\r\n\r\n### 安全性\r\n- **NFR-4**：所有密码应使用 bcrypt 或 argon2 哈希，并使用适当的代价因子\r\n- **NFR-5**：JWT 令牌应使用 HS256 或 RS256 算法，并使用安全密钥\r\n- **NFR-6**：除公开登录端点外，所有 API 端点应强制执行认证\r\n- **NFR-7**：通过参数化查询（SQLAlchemy ORM）防止 SQL 注入\r\n\r\n### 可扩展性\r\n- **NFR-8**：数据库连接应使用连接池\r\n- **NFR-9**：会话状态应存储在数据库中以支持水平扩展\r\n- **NFR-10**：文件存储（技能、工具集）应支持外部存储后端\r\n\r\n### 可维护性\r\n- **NFR-11**：所有端点应有 OpenAPI 文档\r\n- **NFR-12**：代码覆盖率应至少达到 80%\r\n- **NFR-13**：所有公共 API 应有文档字符串\r\n\r\n### 兼容性\r\n- **NFR-14**：API 应遵循 RESTful 约定\r\n- **NFR-15**：WebSocket/SSE 应遵循标准协议以实现广泛的客户端兼容性\r\n- **NFR-16**：系统应支持 PostgreSQL、MySQL 和 SQLite 数据库\r\n\r\n## 成功指标\r\n\r\n1. **用户采用率**：第一个月内有 50+ 活跃用户\r\n2. **性能**：流式传输启动的平均响应时间 <500ms\r\n3. **可靠性**：99.5% 正常运行时间\r\n4. **安全性**：安全审计中零认证/授权漏洞\r\n5. **开发者体验**：完整的 API 文档并包含工作示例\r\n\r\n## 范围外\r\n\r\n- 前端 UI 实现（仅 API）\r\n- 多租户（每次部署一个组织）\r\n- 实时协作（多个用户在同一会话中）\r\n- 语音/音频交互\r\n- Agent 微调或模型训练\r\n\r\n## 依赖项\r\n\r\n- **外部**：pydantic-ai、FastAPI、SQLAlchemy、python-jose（JWT）、bcrypt/argon2\r\n- **内部**：pydantic-deepagents（Agent 工厂、工具集、后端）\r\n- **基础设施**：PostgreSQL/MySQL 数据库、Redis（可选，用于缓存）\r\n\r\n## 风险与缓解措施\r\n\r\n| 风险 | 影响 | 缓解措施 |\r\n|------|--------|-----------|\r\n| 令牌安全漏洞 | 高 | 使用短期令牌、实现刷新令牌、安全密钥存储 |\r\n| Agent 提示注入 | 高 | 输入验证、内容过滤、速率限制 |\r\n| 大量对话历史导致数据库性能问题 | 中 | 实现分页、归档和索引策略 |\r\n| 技能/工具集加载性能 | 中 | 缓存已加载技能、延迟加载、异步初始化 |\r\n| 权限复杂性导致错误 | 中 | 全面测试、清晰文档、权限审计日志 |\r\n\r\n## 假设\r\n\r\n1. 用户对 REST API 有基本了解\r\n2. 管理员可以编写/编辑技能的 markdown 文件\r\n3. 工具集是遵循 pydantic-deepagents 约定的 Python 类\r\n4. 部署环境可以网络访问 LLM 提供商（OpenAI、Anthropic 等）\r\n5. 数据库已设置，迁移在外部处理\r\n\r\n## 术语表\r\n\r\n- **会话（Session）**：用户与 Agent 之间的对话实例\r\n- **技能（Skill）**：以 markdown 格式定义的可重用能力，Agent 可以学习\r\n- **工具集（Toolset）**：Agent 可以调用的 Python 函数/工具集合\r\n- **RBAC**：基于角色的访问控制 - 使用角色的权限系统\r\n- **JWT**：JSON Web Token - 认证令牌标准\r\n- **SSE**：Server-Sent Events - HTTP 流式传输协议\r\n",
  "fileStats": {
    "size": 12574,
    "lines": 284,
    "lastModified": "2025-12-18T09:03:44.441Z"
  },
  "comments": []
}