# Docker Sandbox æ¶æ„ä¸è°ƒç”¨é“¾è·¯è¯¦è§£

## ğŸ¯ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜ Docker æ²™ç®±çš„é…ç½®ã€æŒ‚è½½æœºåˆ¶å’Œå®Œæ•´è°ƒç”¨é“¾è·¯ã€‚

---

## ğŸ“ æ–‡ä»¶ç»“æ„

```
pydantic-deepagents/
â”œâ”€â”€ pydantic_deep/
â”‚   â”œâ”€â”€ sandbox_config.py          # å·æŒ‚è½½é…ç½®å·¥å…·
â”‚   â”œâ”€â”€ backends/
â”‚   â”‚   â””â”€â”€ sandbox.py              # DockerSandbox å®ç°
â”‚   â””â”€â”€ agent.py                    # Agent åˆ›å»ºå…¥å£
â””â”€â”€ src/
    â””â”€â”€ api/
        â””â”€â”€ conversations.py        # FastAPI è·¯ç”± (å®é™…è°ƒç”¨å¤„)
```

---

## ğŸ”§ æ ¸å¿ƒç»„ä»¶

### 1. **sandbox_config.py** - å·æŒ‚è½½é…ç½®

**ä½ç½®**: `pydantic_deep/sandbox_config.py`

**åŠŸèƒ½**: æ„å»º Docker volumes é…ç½®,å°†å®¿ä¸»æœºç›®å½•æŒ‚è½½åˆ°å®¹å™¨

```python
def build_sandbox_volumes(
    work_dir: str | None = None,
) -> dict[str, dict[str, str]]:
    """
    æ„å»º Docker å·é…ç½®,æŒ‚è½½å·¥ä½œç›®å½•åˆ°å®¹å™¨ /workspace

    Args:
        work_dir: è¦æŒ‚è½½çš„ç›®å½• (é»˜è®¤ä¸ºå½“å‰å·¥ä½œç›®å½•)

    Returns:
        Docker volumes å­—å…¸: {host_path: {'bind': container_path, 'mode': 'rw'}}
    """
    if work_dir is None:
        work_dir = os.getcwd()  # é»˜è®¤ä½¿ç”¨å½“å‰ç›®å½•

    volumes = {
        os.path.abspath(work_dir): {
            'bind': '/workspace',    # å®¹å™¨å†…è·¯å¾„
            'mode': 'rw'             # è¯»å†™æƒé™
        }
    }

    return volumes
```

**è¿”å›ç¤ºä¾‹**:
```python
{
    'C:\\code\\python\\pydantic-deepagents': {
        'bind': '/workspace',
        'mode': 'rw'
    }
}
```

---

### 2. **DockerSandbox** - Docker å®¹å™¨ç®¡ç†

**ä½ç½®**: `pydantic_deep/backends/sandbox.py`

#### åˆå§‹åŒ–å‚æ•°

```python
class DockerSandbox(BaseSandbox):
    def __init__(
        self,
        image: str = "python:3.12-slim",      # Docker é•œåƒ
        sandbox_id: str | None = None,        # æ²™ç®±å”¯ä¸€ ID
        work_dir: str = "/workspace",         # å®¹å™¨å†…å·¥ä½œç›®å½•
        auto_remove: bool = True,             # åœæ­¢åè‡ªåŠ¨åˆ é™¤å®¹å™¨
        runtime: RuntimeConfig | str | None = None,  # è¿è¡Œæ—¶é…ç½®
        session_id: str | None = None,        # ä¼šè¯ ID (sandbox_id åˆ«å)
        idle_timeout: int = 3600,             # ç©ºé—²è¶…æ—¶ (ç§’)
        volumes: dict[str, dict[str, str]] | None = None,  # å·æŒ‚è½½é…ç½®
    ):
        ...
```

#### å®¹å™¨å¯åŠ¨æµç¨‹

```python
def _ensure_container(self) -> None:
    """ç¡®ä¿ Docker å®¹å™¨è¿è¡Œ"""

    # 1. å¯¼å…¥ docker åŒ…
    import docker
    client = docker.from_env()

    # 2. ç¡®å®šé•œåƒ (å¯èƒ½éœ€è¦æ„å»º runtime)
    image = self._ensure_runtime_image(client)

    # 3. å‡†å¤‡ç¯å¢ƒå˜é‡ (ä» runtime é…ç½®)
    env_vars = {}
    if self._runtime and self._runtime.env_vars:
        env_vars = self._runtime.env_vars

    # 4. å¯åŠ¨å®¹å™¨
    self._container = client.containers.run(
        image,
        command="sleep infinity",      # ä¿æŒå®¹å™¨è¿è¡Œ
        detach=True,                    # åå°è¿è¡Œ
        working_dir=self._work_dir,     # å·¥ä½œç›®å½•
        auto_remove=self._auto_remove,  # è‡ªåŠ¨æ¸…ç†
        environment=env_vars,           # ç¯å¢ƒå˜é‡
        volumes=self._volumes,          # â­ æŒ‚è½½å·é…ç½®
    )
```

#### æ–‡ä»¶æ“ä½œå®ç°

æ‰€æœ‰æ–‡ä»¶æ“ä½œéƒ½é€šè¿‡ `execute()` æ–¹æ³•æ‰§è¡Œ shell å‘½ä»¤:

```python
def read(self, path: str, offset: int = 0, limit: int = 2000) -> str:
    """è¯»å–æ–‡ä»¶"""
    start = offset + 1
    end = offset + limit
    result = self.execute(f"sed -n '{start},{end}p' {path} | cat -n")
    return result.output

def write(self, path: str, content: str) -> WriteResult:
    """å†™å…¥æ–‡ä»¶"""
    delimiter = f"EOF_{uuid.uuid4().hex[:8]}"
    escaped = content.replace("'", "'\\''")
    result = self.execute(
        f"mkdir -p $(dirname {path}) && cat > {path} << '{delimiter}'\n{escaped}\n{delimiter}"
    )
    return WriteResult(success=result.exit_code == 0, ...)

def ls_info(self, path: str) -> list[FileInfo]:
    """åˆ—å‡ºç›®å½•"""
    result = self.execute(f"ls -la {path}")
    # è§£æè¾“å‡º...

def execute(self, command: str, timeout: int | None = None) -> ExecuteResponse:
    """æ‰§è¡Œå‘½ä»¤"""
    self._ensure_container()  # ç¡®ä¿å®¹å™¨è¿è¡Œ

    exit_code, output_bytes = self._container.exec_run(
        f"bash -c {shlex.quote(command)}",
        workdir=self._work_dir,
        demux=False
    )

    return ExecuteResponse(
        output=output_bytes.decode('utf-8', errors='replace'),
        exit_code=exit_code,
        ...
    )
```

---

## ğŸŒŠ å®Œæ•´è°ƒç”¨é“¾è·¯

### ğŸ“ å…¥å£: FastAPI è·¯ç”±

**æ–‡ä»¶**: `src/api/conversations.py`

```python
@router.post("/{conversation_id}/chat")
async def chat_stream(
    conversation_id: int,
    user_id: int = Query(...),
    body: ChatRequest = ...,
    db: Session = Depends(get_db),
):
    # ============== é˜¶æ®µ 1: è·å–æ¨¡å‹é…ç½® ==============
    from src.services.model_manager import model_manager

    if body.model_name:
        model = model_manager.get_model(body.model_name, db)
    else:
        model = model_manager.get_default_model(db)

    # ============== é˜¶æ®µ 2: æ„å»ºå·æŒ‚è½½é…ç½® ==============
    from pydantic_deep.sandbox_config import build_sandbox_volumes

    volumes = build_sandbox_volumes()
    # è¿”å›: {'C:\\code\\python\\pydantic-deepagents': {'bind': '/workspace', 'mode': 'rw'}}

    # ============== é˜¶æ®µ 3: åˆ›å»º Docker æ²™ç®± ==============
    from pydantic_deep.backends.sandbox import DockerSandbox

    sandbox = DockerSandbox(volumes=volumes)
    # æ­¤æ—¶å®¹å™¨å°šæœªå¯åŠ¨,å»¶è¿Ÿåˆ°ç¬¬ä¸€æ¬¡ execute() è°ƒç”¨

    # ============== é˜¶æ®µ 4: åˆ›å»º Deps ==============
    from pydantic_deep.deps import DeepAgentDeps

    deps = DeepAgentDeps(
        backend=sandbox,              # ä¼ å…¥æ²™ç®±åç«¯
        user_id=user_id,
        conversation_id=conversation_id
    )

    # ============== é˜¶æ®µ 5: åˆ›å»º Agent ==============
    from pydantic_deep import create_deep_agent

    agent = create_deep_agent(
        model=model,                  # æ¨¡å‹é…ç½®
        backend=sandbox,              # åç«¯ (å†³å®šæ˜¯å¦åŒ…å« execute å·¥å…·)
        enable_permission_filtering=False,
        enable_mcp_tools=True,
    )

    # ============== é˜¶æ®µ 6: æµå¼å¯¹è¯ ==============
    async def event_generator():
        async for chunk in service.chat_stream(
            conversation_id=conversation_id,
            user_message=body.message,
            user_id=user_id,
            deps=deps,        # åŒ…å« sandbox backend
            agent=agent       # åŒ…å«å·¥å…·é›†
        ):
            yield f"data: {json.dumps(chunk)}\n\n"

    return StreamingResponse(event_generator(), ...)
```

---

## ğŸ”„ è¿è¡Œæ—¶æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·è¯·æ±‚: POST /api/conversations/5/chat?user_id=1             â”‚
â”‚  Body: {"message": "è¯»å– app.py æ–‡ä»¶"}                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. FastAPI Handler (conversations.py)                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  âœ… è·å–æ¨¡å‹é…ç½®: model_manager.get_model("deepseek-chat", db)  â”‚
â”‚  âœ… æ„å»ºå·é…ç½®: volumes = build_sandbox_volumes()               â”‚
â”‚     è¿”å›: {                                                      â”‚
â”‚       'C:\\code\\python\\pydantic-deepagents': {                â”‚
â”‚         'bind': '/workspace',                                    â”‚
â”‚         'mode': 'rw'                                             â”‚
â”‚       }                                                          â”‚
â”‚     }                                                            â”‚
â”‚  âœ… åˆ›å»ºæ²™ç®±: sandbox = DockerSandbox(volumes=volumes)          â”‚
â”‚  âœ… åˆ›å»º Deps: deps = DeepAgentDeps(backend=sandbox, ...)       â”‚
â”‚  âœ… åˆ›å»º Agent: agent = create_deep_agent(backend=sandbox, ...) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. ConversationService.chat_stream()                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  âœ… åŠ è½½å†å²æ¶ˆæ¯ (ä»æ•°æ®åº“)                                      â”‚
â”‚  âœ… è°ƒç”¨ agent.run_stream(message, deps=deps)                   â”‚
â”‚     - PydanticAI å¼€å§‹å¤„ç†                                        â”‚
â”‚     - åŠ¨æ€æ³¨å…¥ç³»ç»Ÿæç¤ºè¯ (@agent.instructions)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. PydanticAI æ‰§è¡Œ (LLM å†³å®šè°ƒç”¨ read_file å·¥å…·)                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  LLM å“åº”:                                                       â”‚
â”‚  {                                                               â”‚
â”‚    "tool_call": "read_file",                                     â”‚
â”‚    "args": {"path": "app.py"}                                    â”‚
â”‚  }                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. FilesystemToolset.read_file(ctx, "app.py")                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  def read_file(ctx: RunContext[DeepAgentDeps], path: str):      â”‚
â”‚      backend = ctx.deps.backend                                  â”‚
â”‚      content = backend.read(path)  # â­ è°ƒç”¨ sandbox.read()      â”‚
â”‚      return content                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. DockerSandbox.read("app.py")                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  def read(self, path: str, offset=0, limit=2000):                â”‚
â”‚      # âš¡ é¦–æ¬¡è°ƒç”¨æ—¶å¯åŠ¨å®¹å™¨                                      â”‚
â”‚      result = self.execute(                                      â”‚
â”‚          f"sed -n '1,2000p' app.py | cat -n"                     â”‚
â”‚      )                                                           â”‚
â”‚      return result.output                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  6. DockerSandbox._ensure_container()                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  if self._container is None:                                     â”‚
â”‚      client = docker.from_env()                                  â”‚
â”‚      self._container = client.containers.run(                    â”‚
â”‚          image="python:3.12-slim",                               â”‚
â”‚          command="sleep infinity",                               â”‚
â”‚          working_dir="/workspace",                               â”‚
â”‚          volumes=self._volumes,  # â­ æŒ‚è½½å®¿ä¸»æœºç›®å½•             â”‚
â”‚          detach=True,                                            â”‚
â”‚      )                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  7. Docker å®¹å™¨å¯åŠ¨ (docker run)                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å®¹å™¨é…ç½®:                                                        â”‚
â”‚    é•œåƒ: python:3.12-slim                                        â”‚
â”‚    å‘½ä»¤: sleep infinity                                          â”‚
â”‚    å·¥ä½œç›®å½•: /workspace                                          â”‚
â”‚    æŒ‚è½½:                                                         â”‚
â”‚      C:\code\python\pydantic-deepagents -> /workspace (rw)       â”‚
â”‚                                                                  â”‚
â”‚  å®¹å™¨å†…æ–‡ä»¶ç³»ç»Ÿ:                                                  â”‚
â”‚    /workspace/                                                   â”‚
â”‚    â”œâ”€â”€ app.py          â† å®¿ä¸»æœºæ–‡ä»¶                              â”‚
â”‚    â”œâ”€â”€ pydantic_deep/  â† å®¿ä¸»æœºç›®å½•                              â”‚
â”‚    â”œâ”€â”€ src/            â† å®¿ä¸»æœºç›®å½•                              â”‚
â”‚    â””â”€â”€ ...                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  8. DockerSandbox.execute("sed -n '1,2000p' app.py | cat -n")   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  def execute(self, command: str):                                â”‚
â”‚      exit_code, output = self._container.exec_run(               â”‚
â”‚          f"bash -c {shlex.quote(command)}",                      â”‚
â”‚          workdir="/workspace",                                   â”‚
â”‚      )                                                           â”‚
â”‚      return ExecuteResponse(                                     â”‚
â”‚          output=output.decode('utf-8'),                          â”‚
â”‚          exit_code=exit_code                                     â”‚
â”‚      )                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  9. å®¹å™¨å†…æ‰§è¡Œ Shell å‘½ä»¤                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  $ cd /workspace                                                 â”‚
â”‚  $ sed -n '1,2000p' app.py | cat -n                              â”‚
â”‚                                                                  â”‚
â”‚  è¾“å‡º:                                                           â”‚
â”‚       1  from fastapi import FastAPI                             â”‚
â”‚       2  from src.database import engine                         â”‚
â”‚       3  ...                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  10. è¿”å›ç»“æœ (é€†å‘å›æº¯)                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  execute() è¿”å› â†’ read() è¿”å› â†’ read_file() è¿”å›                 â”‚
â”‚  â†’ PydanticAI è·å¾—å·¥å…·ç»“æœ â†’ å‘é€ç»™ LLM                          â”‚
â”‚  â†’ LLM ç”Ÿæˆæœ€ç»ˆå“åº” â†’ æµå¼è¿”å›ç»™å‰ç«¯                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—‚ï¸ æŒ‚è½½é…ç½®è¯¦è§£

### å·æŒ‚è½½çš„å·¥ä½œåŸç†

```python
volumes = {
    'C:\\code\\python\\pydantic-deepagents': {  # å®¿ä¸»æœºè·¯å¾„ (ç»å¯¹è·¯å¾„)
        'bind': '/workspace',                    # å®¹å™¨å†…è·¯å¾„
        'mode': 'rw'                             # è¯»å†™æ¨¡å¼
    }
}
```

### å®é™…æ•ˆæœ

| å®¿ä¸»æœºè·¯å¾„ | å®¹å™¨è·¯å¾„ | æƒé™ |
|-----------|---------|------|
| `C:\code\python\pydantic-deepagents\app.py` | `/workspace/app.py` | è¯»å†™ |
| `C:\code\python\pydantic-deepagents\pydantic_deep\agent.py` | `/workspace/pydantic_deep/agent.py` | è¯»å†™ |
| `C:\code\python\pydantic-deepagents\src\api\conversations.py` | `/workspace/src/api/conversations.py` | è¯»å†™ |

### ä¸ºä»€ä¹ˆéœ€è¦æŒ‚è½½?

1. **æ–‡ä»¶æŒä¹…åŒ–**: å®¹å™¨å†…çš„ä¿®æ”¹ç›´æ¥åæ˜ åˆ°å®¿ä¸»æœº
2. **ä»£ç è®¿é—®**: LLM å¯ä»¥è¯»å–/ä¿®æ”¹é¡¹ç›®æ–‡ä»¶
3. **è·¯å¾„ä¸€è‡´æ€§**: å®¹å™¨å’Œå®¿ä¸»æœºçœ‹åˆ°ç›¸åŒçš„æ–‡ä»¶ç»“æ„
4. **æ€§èƒ½**: é¿å…æ–‡ä»¶å¤åˆ¶,ç›´æ¥æ“ä½œå®¿ä¸»æœºæ–‡ä»¶ç³»ç»Ÿ

---

## âš™ï¸ é…ç½®æ–¹å¼

### æ–¹å¼ 1: é»˜è®¤é…ç½® (è‡ªåŠ¨æŒ‚è½½å½“å‰ç›®å½•)

```python
from pydantic_deep.sandbox_config import build_sandbox_volumes
from pydantic_deep.backends.sandbox import DockerSandbox

# è‡ªåŠ¨ä½¿ç”¨ os.getcwd() ä½œä¸ºå·¥ä½œç›®å½•
volumes = build_sandbox_volumes()
sandbox = DockerSandbox(volumes=volumes)
```

### æ–¹å¼ 2: æŒ‡å®šç›®å½•

```python
volumes = build_sandbox_volumes("/path/to/project")
sandbox = DockerSandbox(volumes=volumes)
```

### æ–¹å¼ 3: è‡ªå®šä¹‰å¤šä¸ªæŒ‚è½½

```python
custom_volumes = {
    '/host/project': {'bind': '/workspace', 'mode': 'rw'},
    '/host/data': {'bind': '/data', 'mode': 'ro'},      # åªè¯»
    '/host/output': {'bind': '/output', 'mode': 'rw'},
}

sandbox = DockerSandbox(volumes=custom_volumes)
```

---

## ğŸ” å…³é”®è®¾è®¡å†³ç­–

### 1. **å»¶è¿Ÿå¯åŠ¨å®¹å™¨**
```python
def _ensure_container(self):
    if self._container is not None:
        return  # å·²å¯åŠ¨,ç›´æ¥è¿”å›

    # é¦–æ¬¡è°ƒç”¨æ—¶æ‰å¯åŠ¨
    self._container = client.containers.run(...)
```

**ä¼˜åŠ¿**:
- èŠ‚çœèµ„æº (ä¸ç«‹å³å¯åŠ¨å®¹å™¨)
- å‡å°‘å¯åŠ¨æ—¶é—´ (æŒ‰éœ€å¯åŠ¨)

### 2. **è‡ªåŠ¨æ¸…ç†**
```python
DockerSandbox(auto_remove=True, idle_timeout=3600)
```

**æœºåˆ¶**:
- å®¹å™¨åœæ­¢åè‡ªåŠ¨åˆ é™¤ (`auto_remove=True`)
- 1 å°æ—¶ç©ºé—²åè‡ªåŠ¨è¶…æ—¶

### 3. **å·¥ä½œç›®å½•ç»Ÿä¸€**
```python
working_dir="/workspace"  # å®¹å™¨å†…
volumes={host_dir: {'bind': '/workspace', ...}}  # æŒ‚è½½åˆ° /workspace
```

**ä¼˜åŠ¿**:
- æ‰€æœ‰æ–‡ä»¶æ“ä½œéƒ½åœ¨ `/workspace` ä¸‹
- è·¯å¾„ç®€å•æ˜äº†,ä¸æ˜“å‡ºé”™

### 4. **å‘½ä»¤æ‰§è¡Œå°è£…**
æ‰€æœ‰æ–‡ä»¶æ“ä½œé€šè¿‡ `execute()` æ‰§è¡Œ shell å‘½ä»¤:

```python
# read() å®ç°
self.execute(f"sed -n '{start},{end}p' {path} | cat -n")

# write() å®ç°
self.execute(f"cat > {path} << 'EOF'\n{content}\nEOF")

# ls() å®ç°
self.execute(f"ls -la {path}")
```

**ä¼˜åŠ¿**:
- ç»Ÿä¸€é”™è¯¯å¤„ç†
- æ”¯æŒå¤æ‚ shell å‘½ä»¤
- åˆ©ç”¨ Linux å·¥å…·é“¾çš„å¼ºå¤§åŠŸèƒ½

---

## ğŸš€ å®é™…ä½¿ç”¨åœºæ™¯

### åœºæ™¯ 1: è¯»å–æ–‡ä»¶

```
ç”¨æˆ·: "è¯»å– app.py æ–‡ä»¶"
  â†“
LLM è°ƒç”¨ read_file("app.py")
  â†“
backend.read("app.py")
  â†“
å®¹å™¨æ‰§è¡Œ: sed -n '1,2000p' /workspace/app.py | cat -n
  â†“
è¿”å›æ–‡ä»¶å†…å®¹ (å¸¦è¡Œå·)
```

### åœºæ™¯ 2: æ‰§è¡Œä»£ç 

```
ç”¨æˆ·: "è¿è¡Œ tests/test_agent.py"
  â†“
LLM è°ƒç”¨ execute("pytest tests/test_agent.py")
  â†“
backend.execute("pytest tests/test_agent.py")
  â†“
å®¹å™¨æ‰§è¡Œ: cd /workspace && pytest tests/test_agent.py
  â†“
è¿”å›æµ‹è¯•ç»“æœ
```

### åœºæ™¯ 3: ä¿®æ”¹æ–‡ä»¶

```
ç”¨æˆ·: "åœ¨ app.py ç¬¬ 10 è¡Œæ·»åŠ æ—¥å¿—"
  â†“
LLM è°ƒç”¨ read_file("app.py")
  â†“
LLM è°ƒç”¨ write_file("app.py", new_content)
  â†“
backend.write("app.py", new_content)
  â†“
å®¹å™¨æ‰§è¡Œ: cat > /workspace/app.py << 'EOF'
          [new_content]
          EOF
  â†“
æ–‡ä»¶ä¿®æ”¹ (å®¿ä¸»æœºå’Œå®¹å™¨åŒæ­¥ç”Ÿæ•ˆ)
```

---

## ğŸ“Š æ€§èƒ½è€ƒè™‘

### å®¹å™¨ç”Ÿå‘½å‘¨æœŸ

```
è¯·æ±‚ 1 (15:51:45):
  â”œâ”€> å¯åŠ¨å®¹å™¨ (~2-3ç§’)
  â”œâ”€> æ‰§è¡Œå‘½ä»¤ (read_todos)
  â””â”€> ä¿æŒè¿è¡Œ (sleep infinity)

è¯·æ±‚ 2 (15:51:50):
  â”œâ”€> å¤ç”¨å®¹å™¨ (0ç§’)
  â”œâ”€> æ‰§è¡Œå‘½ä»¤ (execute date)
  â””â”€> ä¿æŒè¿è¡Œ

... (1å°æ—¶å†…æŒç»­å¤ç”¨)

ç©ºé—² 1 å°æ—¶å:
  â””â”€> è‡ªåŠ¨æ¸…ç†å®¹å™¨
```

### æŒ‚è½½å¼€é”€

- **è¯»å†™**: ç›´æ¥æ“ä½œå®¿ä¸»æœºæ–‡ä»¶ç³»ç»Ÿ,æ— é¢å¤–å¼€é”€
- **é¦–æ¬¡å¯åŠ¨**: ~2-3 ç§’ (æ‹‰å–é•œåƒ + å¯åŠ¨å®¹å™¨)
- **åç»­è°ƒç”¨**: ~50-100ms (ä»…æ‰§è¡Œå‘½ä»¤)

---

## ğŸ›¡ï¸ å®‰å…¨æ€§

### éš”ç¦»æ€§

âœ… **è¿›ç¨‹éš”ç¦»**: å®¹å™¨å†…è¿›ç¨‹ä¸å®¿ä¸»æœºéš”ç¦»
âœ… **ç½‘ç»œéš”ç¦»**: é»˜è®¤æ— ç½‘ç»œè®¿é—® (å¯é…ç½®)
âœ… **èµ„æºé™åˆ¶**: å¯è®¾ç½® CPU/å†…å­˜é™åˆ¶

### é£é™©ç‚¹

âš ï¸ **æ–‡ä»¶è®¿é—®**: å®¹å™¨å¯è¯»å†™æŒ‚è½½ç›®å½•å†…æ‰€æœ‰æ–‡ä»¶
âš ï¸ **å‘½ä»¤æ‰§è¡Œ**: å¯æ‰§è¡Œä»»æ„ shell å‘½ä»¤ (åœ¨å®¹å™¨å†…)

### æœ€ä½³å®è·µ

```python
# 1. åªè¯»æŒ‚è½½æ•æ„Ÿç›®å½•
volumes = {
    '/etc/config': {'bind': '/config', 'mode': 'ro'}  # åªè¯»
}

# 2. é™åˆ¶å·¥ä½œç›®å½•
volumes = build_sandbox_volumes('/safe/project/dir')

# 3. ä½¿ç”¨æœ€å°æƒé™é•œåƒ
DockerSandbox(image="python:3.12-slim")  # è€Œé python:3.12
```

---

## ğŸ“ æ€»ç»“

### è°ƒç”¨é“¾è·¯æ¦‚è§ˆ

```
FastAPI è¯·æ±‚
  â†“
build_sandbox_volumes() â†’ ç”Ÿæˆå·é…ç½®
  â†“
DockerSandbox(volumes=...) â†’ åˆ›å»ºæ²™ç®±å®ä¾‹
  â†“
create_deep_agent(backend=sandbox) â†’ åˆ›å»º Agent
  â†“
agent.run_stream(...) â†’ å¼€å§‹å¯¹è¯
  â†“
LLM è°ƒç”¨å·¥å…· (read_file/execute/...)
  â†“
FilesystemToolset â†’ backend.read()/execute()
  â†“
DockerSandbox._ensure_container() â†’ å¯åŠ¨å®¹å™¨ (é¦–æ¬¡)
  â†“
_container.exec_run(command) â†’ æ‰§è¡Œå‘½ä»¤
  â†“
å®¹å™¨å†… shell æ‰§è¡Œ
  â†“
è¿”å›ç»“æœ â†’ LLM â†’ ç”¨æˆ·
```

### æ ¸å¿ƒé…ç½®

```python
# å®Œæ•´é…ç½®ç¤ºä¾‹
from pydantic_deep.sandbox_config import build_sandbox_volumes
from pydantic_deep.backends.sandbox import DockerSandbox

volumes = build_sandbox_volumes()  # è‡ªåŠ¨æŒ‚è½½å½“å‰ç›®å½•åˆ° /workspace

sandbox = DockerSandbox(
    volumes=volumes,               # å·æŒ‚è½½
    image="python:3.12-slim",      # åŸºç¡€é•œåƒ
    work_dir="/workspace",         # å·¥ä½œç›®å½•
    auto_remove=True,              # è‡ªåŠ¨æ¸…ç†
    idle_timeout=3600,             # 1å°æ—¶è¶…æ—¶
)
```

### å…³é”®ç‰¹æ€§

1. âœ… **è‡ªåŠ¨æŒ‚è½½**: å½“å‰ç›®å½• â†’ `/workspace`
2. âœ… **å»¶è¿Ÿå¯åŠ¨**: é¦–æ¬¡è°ƒç”¨æ—¶å¯åŠ¨å®¹å™¨
3. âœ… **æŒä¹…å¤ç”¨**: åŒä¸€ä¼šè¯å¤ç”¨å®¹å™¨
4. âœ… **è‡ªåŠ¨æ¸…ç†**: ç©ºé—² 1 å°æ—¶ååˆ é™¤
5. âœ… **æ–‡ä»¶åŒæ­¥**: å®¹å™¨ä¿®æ”¹ç›´æ¥åæ˜ åˆ°å®¿ä¸»æœº
